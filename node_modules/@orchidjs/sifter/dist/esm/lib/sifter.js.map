{"version":3,"file":"sifter.js","sources":["../../../lib/sifter.ts"],"sourcesContent":["/**\n * sifter.js\n * Copyright (c) 2013â€“2020 Brian Reavis & contributors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this\n * file except in compliance with the License. You may obtain a copy of the License at:\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under\n * the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF\n * ANY KIND, either express or implied. See the License for the specific language\n * governing permissions and limitations under the License.\n *\n * @author Brian Reavis <brian@thirdroute.com>\n */\n\nimport { scoreValue, getAttr, getAttrNesting, propToArray, iterate, cmp } from './utils';\nimport { getPattern, escape_regex } from '@orchidjs/unicode-variants';\nimport * as T from './types';\n\nclass Sifter{\n\n\tpublic items: any; // []|{};\n\tpublic settings: T.Settings;\n\n\t/**\n\t * Textually searches arrays and hashes of objects\n\t * by property (or multiple properties). Designed\n\t * specifically for autocomplete.\n\t *\n\t */\n\tconstructor(items:any, settings:T.Settings) {\n\t\tthis.items = items;\n\t\tthis.settings = settings || {diacritics: true};\n\t};\n\n\t/**\n\t * Splits a search string into an array of individual\n\t * regexps to be used to match results.\n\t *\n\t */\n\ttokenize(query:string, respect_word_boundaries?:boolean, weights?:T.Weights ):T.Token[] {\n\t\tif (!query || !query.length) return [];\n\n\t\tconst tokens:T.Token[]\t= [];\n\t\tconst words\t\t\t\t= query.split(/\\s+/);\n\t\tvar field_regex:RegExp;\n\n\t\tif( weights ){\n\t\t\tfield_regex = new RegExp( '^('+ Object.keys(weights).map(escape_regex).join('|')+')\\:(.*)$');\n\t\t}\n\n\t\twords.forEach((word:string) => {\n\t\t\tlet field_match;\n\t\t\tlet field:null|string\t= null;\n\t\t\tlet regex:null|string\t= null;\n\n\t\t\t// look for \"field:query\" tokens\n\t\t\tif( field_regex && (field_match = word.match(field_regex)) ){\n\t\t\t\tfield\t= field_match[1]!;\n\t\t\t\tword\t= field_match[2]!;\n\t\t\t}\n\n\t\t\tif( word.length > 0 ){\n\t\t\t\tif( this.settings.diacritics ){\n\t\t\t\t\tregex = getPattern(word) || null;\n\t\t\t\t}else{\n\t\t\t\t\tregex = escape_regex(word);\n\t\t\t\t}\n\t\t\t\tif( regex && respect_word_boundaries ) regex = \"\\\\b\"+regex;\n\t\t\t}\n\n\t\t\ttokens.push({\n\t\t\t\tstring : word,\n\t\t\t\tregex  : regex ? new RegExp(regex,'iu') : null,\n\t\t\t\tfield  : field,\n\t\t\t});\n\t\t});\n\n\t\treturn tokens;\n\t};\n\n\n\t/**\n\t * Returns a function to be used to score individual results.\n\t *\n\t * Good matches will have a higher score than poor matches.\n\t * If an item is not a match, 0 will be returned by the function.\n\t *\n\t * @returns {T.ScoreFn}\n\t */\n\tgetScoreFunction(query:string, options:T.UserOptions ){\n\t\tvar search = this.prepareSearch(query, options);\n\t\treturn this._getScoreFunction(search);\n\t}\n\n\t/**\n\t * @returns {T.ScoreFn}\n\t *\n\t */\n\t_getScoreFunction(search:T.PrepareObj ){\n\t\tconst tokens\t\t= search.tokens,\n\t\ttoken_count\t\t\t= tokens.length;\n\n\t\tif (!token_count) {\n\t\t\treturn function() { return 0; };\n\t\t}\n\n\t\tconst fields\t= search.options.fields,\n\t\tweights\t\t\t= search.weights,\n\t\tfield_count\t\t= fields.length,\n\t\tgetAttrFn\t\t= search.getAttrFn;\n\n\t\tif (!field_count) {\n\t\t\treturn function() { return 1; };\n\t\t}\n\n\n\t\t/**\n\t\t * Calculates the score of an object\n\t\t * against the search query.\n\t\t *\n\t\t */\n\t\tconst scoreObject = (function() {\n\n\n\t\t\tif (field_count === 1) {\n\t\t\t\treturn function(token:T.Token, data:{}) {\n\t\t\t\t\tconst field = fields[0]!.field;\n\t\t\t\t\treturn scoreValue(getAttrFn(data, field), token, weights[field]||1);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn function(token:T.Token, data:{}) {\n\t\t\t\tvar sum = 0;\n\n\t\t\t\t// is the token specific to a field?\n\t\t\t\tif( token.field ){\n\n\t\t\t\t\tconst value = getAttrFn(data, token.field);\n\n\t\t\t\t\tif( !token.regex && value ){\n\t\t\t\t\t\tsum += (1/field_count);\n\t\t\t\t\t}else{\n\t\t\t\t\t\tsum += scoreValue(value, token, 1);\n\t\t\t\t\t}\n\n\n\n\t\t\t\t}else{\n\t\t\t\t\titerate(weights, (weight:number, field:string) => {\n\t\t\t\t\t\tsum += scoreValue(getAttrFn(data, field), token, weight);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn sum / field_count;\n\t\t\t};\n\t\t})();\n\n\t\tif (token_count === 1) {\n\t\t\treturn function(data:{}) {\n\t\t\t\treturn scoreObject(tokens[0]!, data);\n\t\t\t};\n\t\t}\n\n\t\tif (search.options.conjunction === 'and') {\n\t\t\treturn function(data:{}) {\n\t\t\t\tvar score, sum = 0;\n\t\t\t\tfor( let token of tokens){\n\t\t\t\t\tscore = scoreObject(token, data);\n\t\t\t\t\tif (score <= 0) return 0;\n\t\t\t\t\tsum += score;\n\t\t\t\t}\n\t\t\t\treturn sum / token_count;\n\t\t\t};\n\t\t} else {\n\t\t\treturn function(data:{}) {\n\t\t\t\tvar sum = 0;\n\t\t\t\titerate(tokens,(token:T.Token)=>{\n\t\t\t\t\tsum += scoreObject(token, data);\n\t\t\t\t});\n\t\t\t\treturn sum / token_count;\n\t\t\t};\n\t\t}\n\t};\n\n\t/**\n\t * Returns a function that can be used to compare two\n\t * results, for sorting purposes. If no sorting should\n\t * be performed, `null` will be returned.\n\t *\n\t * @return function(a,b)\n\t */\n\tgetSortFunction(query:string, options:T.UserOptions) {\n\t\tvar search  = this.prepareSearch(query, options);\n\t\treturn this._getSortFunction(search);\n\t}\n\n\t_getSortFunction(search:T.PrepareObj){\n\t\tvar implicit_score,\n\t\tsort_flds:T.Sort[]\t= [];\n\n\t\tconst self\t= this,\n\t\toptions\t\t= search.options,\n\t\tsort\t\t= (!search.query && options.sort_empty) ? options.sort_empty : options.sort;\n\n\n\t\tif( typeof sort == 'function' ){\n\t\t\treturn sort.bind(this);\n\t\t}\n\n\t\t/**\n\t\t * Fetches the specified sort field value\n\t\t * from a search result item.\n\t\t *\n\t\t */\n\t\tconst get_field = function(name:string, result:T.ResultItem):string|number {\n\t\t\tif (name === '$score') return result.score;\n\t\t\treturn search.getAttrFn(self.items[result.id], name);\n\t\t};\n\n\t\t// parse options\n\t\tif (sort) {\n\t\t\tfor( let s of sort ){\n\t\t\t\tif (search.query || s.field !== '$score') {\n\t\t\t\t\tsort_flds.push(s);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// the \"$score\" field is implied to be the primary\n\t\t// sort field, unless it's manually specified\n\t\tif (search.query) {\n\t\t\timplicit_score = true;\n\t\t\tfor( let fld of sort_flds ){\n\t\t\t\tif( fld.field === '$score' ){\n\t\t\t\t\timplicit_score = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (implicit_score) {\n\t\t\t\tsort_flds.unshift({field: '$score', direction: 'desc'});\n\t\t\t}\n\n\t\t// without a search.query, all items will have the same score\n\t\t} else {\n\t\t\tsort_flds = sort_flds.filter((fld) => fld.field !== '$score' );\n\t\t}\n\n\n\t\t// build function\n\t\tconst sort_flds_count = sort_flds.length;\n\t\tif (!sort_flds_count) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn function(a:T.ResultItem, b:T.ResultItem) {\n\t\t\tvar result, field;\n\t\t\tfor( let sort_fld of sort_flds ){\n\t\t\t\tfield = sort_fld.field;\n\n\t\t\t\tlet\tmultiplier = sort_fld.direction === 'desc' ? -1 : 1;\n\n\t\t\t\tresult = multiplier * cmp(\n\t\t\t\t\tget_field(field, a),\n\t\t\t\t\tget_field(field, b)\n\t\t\t\t);\n\t\t\t\tif (result) return result;\n\t\t\t}\n\t\t\treturn 0;\n\t\t};\n\n\t};\n\n\t/**\n\t * Parses a search query and returns an object\n\t * with tokens and fields ready to be populated\n\t * with results.\n\t *\n\t */\n\tprepareSearch(query:string, optsUser:T.UserOptions):T.PrepareObj {\n\t\tconst weights:T.Weights = {};\n\t\tvar options\t\t= Object.assign({},optsUser) as T.Options;\n\n\t\tpropToArray(options,'sort');\n\t\tpropToArray(options,'sort_empty');\n\n\t\t// convert fields to new format\n\t\tif( options.fields ){\n\t\t\tpropToArray(options,'fields');\n\t\t\tconst fields:T.Field[] = [];\n\t\t\toptions.fields.forEach((field:string|T.Field) => {\n\t\t\t\tif( typeof field == 'string' ){\n\t\t\t\t\tfield = {field:field,weight:1};\n\t\t\t\t}\n\t\t\t\tfields.push(field);\n\t\t\t\tweights[field.field] = ('weight' in field) ? field.weight : 1;\n\t\t\t});\n\t\t\toptions.fields = fields;\n\t\t}\n\n\n\t\treturn {\n\t\t\toptions\t\t: options as T.Options,\n\t\t\tquery\t\t: query.toLowerCase().trim(),\n\t\t\ttokens\t\t: this.tokenize(query, options.respect_word_boundaries, weights),\n\t\t\ttotal\t\t: 0,\n\t\t\titems\t\t: [],\n\t\t\tweights\t\t: weights,\n\t\t\tgetAttrFn\t: (options.nesting) ? getAttrNesting : getAttr,\n\t\t};\n\t};\n\n\t/**\n\t * Searches through all items and returns a sorted array of matches.\n\t *\n\t */\n\tsearch(query:string, options:T.UserOptions) : T.PrepareObj {\n\t\tvar self = this, score, search: T.PrepareObj;\n\n\t\tsearch  = this.prepareSearch(query, options);\n\t\toptions = search.options;\n\t\tquery   = search.query;\n\n\t\t// generate result scoring function\n\t\tconst fn_score:T.ScoreFn = options.score || self._getScoreFunction(search);\n\n\t\t// perform search and sort\n\t\tif (query.length) {\n\t\t\titerate(self.items, (item:T.ResultItem, id:string|number) => {\n\t\t\t\tscore = fn_score(item);\n\t\t\t\tif (options.filter === false || score > 0) {\n\t\t\t\t\tsearch.items.push({'score': score, 'id': id});\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\titerate(self.items, (_:T.ResultItem, id:string|number) => {\n\t\t\t\tsearch.items.push({'score': 1, 'id': id});\n\t\t\t});\n\t\t}\n\n\t\tconst fn_sort = self._getSortFunction(search);\n\t\tif (fn_sort) search.items.sort(fn_sort);\n\n\t\t// apply limits\n\t\tsearch.total = search.items.length;\n\t\tif (typeof options.limit === 'number') {\n\t\t\tsearch.items = search.items.slice(0, options.limit);\n\t\t}\n\n\t\treturn search;\n\t};\n}\n\nexport { Sifter, scoreValue, getAttr, getAttrNesting, propToArray, iterate, cmp, getPattern }\n"],"names":["Sifter","constructor","items","settings","diacritics","tokenize","query","respect_word_boundaries","weights","length","tokens","words","split","field_regex","RegExp","Object","keys","map","escape_regex","join","forEach","word","field_match","field","regex","match","getPattern","push","string","getScoreFunction","options","search","prepareSearch","_getScoreFunction","token_count","fields","field_count","getAttrFn","scoreObject","token","data","scoreValue","sum","value","iterate","weight","conjunction","score","getSortFunction","_getSortFunction","implicit_score","sort_flds","self","sort","sort_empty","bind","get_field","name","result","id","s","fld","unshift","direction","filter","sort_flds_count","a","b","sort_fld","multiplier","cmp","optsUser","assign","propToArray","toLowerCase","trim","total","nesting","getAttrNesting","getAttr","fn_score","item","_","fn_sort","limit","slice"],"mappings":"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"}